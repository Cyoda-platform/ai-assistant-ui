name: Build and Publish Electron App

on:
  push:
    tags:
      - 'v*'

jobs:
  create-tag:
    # Run only when pushing tags
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.existing_tag.outputs.new_tag }}
      version: ${{ steps.existing_tag.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Use existing tag info
        id: existing_tag
        run: |
          # Extract tag from ref
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          
          echo "ðŸ·ï¸ Using existing tag: $TAG_NAME"
          echo "ðŸ“‹ Version: $VERSION"
          
          # Set outputs for existing tag
          echo "new_tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: release_notes
        run: |
          # Generate automatic release notes
          echo "ðŸ“ Generating release notes..."
          
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -n "$LAST_TAG" ]; then
            echo "ðŸ“‹ Changes since $LAST_TAG:"
            COMMITS=$(git log $LAST_TAG..HEAD --oneline --pretty=format:"- %s" | head -20)
          else
            echo "ðŸ“‹ Initial release - all changes:"
            COMMITS=$(git log --oneline --pretty=format:"- %s" | head -20)
          fi
          
          # Create release notes
          VERSION="${{ steps.existing_tag.outputs.version }}"
          cat > release_notes.md << EOF
          ## ðŸš€ What's New in $VERSION
          
          This release includes the following changes:
          
          ### ðŸ“‹ Changes
          $COMMITS
          
          ### ðŸ“¦ Downloads
          - **macOS**: Download the DMG file and follow simple installation guide
          - **Linux**: Use the .deb, .rpm, or .AppImage file depending on your distribution  
          - **Windows**: Use the .exe installer
          
          ### âš ï¸ Installation Notes
          - **macOS users**: Right-click app â†’ Open (or use System Preferences â†’ Security & Privacy)
          - **Linux users**: Choose the package format that matches your distribution
          - **Windows users**: Run the .exe installer with administrator privileges if needed
          
          ### ðŸ”§ Technical Details
          - Built with Electron Forge
          - Cross-platform support (Linux x64/arm64, macOS arm64, Windows x64)
          - Unsigned macOS build with simple right-click installation
          EOF
          
          echo "âœ… Release notes generated"

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: release_notes.md
          retention-days: 1

  # Cross-platform build with matrix strategy
  build:
    needs: [ create-tag ]
    if: always() && needs.create-tag.result == 'success' && startsWith(github.ref, 'refs/tags/')
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64,arm64
            artifact_name: cyoda-linux
            files: |
              packages/desktop/out/cyoda-build/make/*.deb
              packages/desktop/out/cyoda-build/make/*.rpm
              packages/desktop/out/cyoda-build/make/*.tar.gz
              packages/desktop/out/cyoda-build/make/*.AppImage
          - os: macos-latest
            platform: darwin
            arch: arm64
            artifact_name: cyoda-macos-arm64
            files: |
              packages/desktop/out/cyoda-build/make/*.dmg
              packages/desktop/out/cyoda-build/make/*.zip
              packages/desktop/out/cyoda-build/make/README-INSTALLATION.md
          - os: windows-latest
            platform: win32
            arch: x64
            artifact_name: cyoda-windows-x64
            files: |
              packages/desktop/out/cyoda-build/make/*.exe
              packages/desktop/out/cyoda-build/make/*.msi
              packages/desktop/out/cyoda-build/make/*.nupkg
    runs-on: ${{ matrix.os }}
    env:
      NODE_OPTIONS: --disable-warning=DEP0174
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      VITE_APP_API_BASE: ${{ vars.VITE_APP_API_BASE }}
      VITE_APP_BASE_URL: ${{ vars.VITE_APP_BASE_URL }}
      VITE_APP_AUTH0_DOMAIN: ${{ vars.VITE_APP_AUTH0_DOMAIN }}
      VITE_APP_AUTH0_CLIENT_ID: ${{ vars.VITE_APP_AUTH0_CLIENT_ID }}
      VITE_APP_AUTH0_AUDIENCE: ${{ vars.VITE_APP_AUTH0_AUDIENCE }}
      VITE_APP_AUTH0_REDIRECT_URI: ${{ vars.VITE_APP_AUTH0_REDIRECT_URI }}
      VITE_APP_AUTH0_ORGANIZATION: ${{ vars.VITE_APP_AUTH0_ORGANIZATION }}
      VITE_IS_ELECTRON: true
      # Apple signing credentials (optional for macOS)
      ENABLE_CODE_SIGNING: ${{ secrets.ENABLE_CODE_SIGNING || 'false' }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-tag.outputs.new_tag || github.ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.yarn/cache
            node_modules
            packages/desktop/node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Enable Corepack
        run: corepack enable

      - name: Prepare Yarn version
        run: |
          echo "ðŸ”„ Setting up Yarn..."
          corepack prepare yarn@4.5.3 --activate
          yarn --version
          echo "âœ… Yarn version ready"
        shell: bash

      - name: Install workspace dependencies
        run: |
          echo "ðŸ”„ Installing workspace dependencies..."
          yarn install
          echo "âœ… Workspace dependencies installed"
          echo "ðŸ“‹ Workspace info:"
          yarn workspaces list
        shell: bash

      - name: Update package version
        run: |
          VERSION="${{ needs.create-tag.outputs.version }}"
          echo "ðŸ”„ Updating package.json version to $VERSION"
          # Update version in packages/desktop/package.json (cross-platform)
          node -e "
            const fs = require('fs');
            const path = 'packages/desktop/package.json';
            const pkg = JSON.parse(fs.readFileSync(path, 'utf8'));
            pkg.version = process.argv[1];
            fs.writeFileSync(path, JSON.stringify(pkg, null, 2) + '\n');
            console.log('âœ… Version updated to', pkg.version);
          " "$VERSION"
        shell: bash

      - name: Download release notes
        if: needs.create-tag.outputs.new_tag != ''
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      - name: Build for Linux
        if: matrix.platform == 'linux'
        run: |
          echo "ðŸ”§ Building for Linux..."
          yarn workspace desktop make --platform=linux --arch=${{ matrix.arch }}
        timeout-minutes: 10
        shell: bash

      - name: Build for macOS (unsigned)
        if: matrix.platform == 'darwin'
        run: |
          echo "ðŸ”§ Building for macOS (unsigned)..."
          yarn workspace desktop make:unsigned
          
          echo "ðŸ”§ Preparing unsigned app for distribution..."
          cd packages/desktop
          
          # Find and process .app files
          find out -name "*.app" -type d | while read APP_PATH; do
            echo "ðŸ“± Processing: $APP_PATH"
            # Remove extended attributes (quarantine)
            sudo xattr -rc "$APP_PATH" 2>/dev/null || true
            sudo xattr -d com.apple.quarantine "$APP_PATH" 2>/dev/null || true
            # Make executable
            chmod +x "$APP_PATH/Contents/MacOS/"* 2>/dev/null || true
            # Remove quarantine from all files in the app bundle
            find "$APP_PATH" -type f -exec sudo xattr -d com.apple.quarantine {} \; 2>/dev/null || true
            echo "âœ… Processed: $APP_PATH"
          done
          
          # Process .dmg files
          find out -name "*.dmg" -type f | while read DMG_PATH; do
            echo "ðŸ’¿ Processing DMG: $DMG_PATH"
            sudo xattr -rc "$DMG_PATH" 2>/dev/null || true
            sudo xattr -d com.apple.quarantine "$DMG_PATH" 2>/dev/null || true
            echo "âœ… DMG processed: $DMG_PATH"
          done
          
          # Process .zip files
          find out -name "*.zip" -type f | while read ZIP_PATH; do
            echo "ðŸ“¦ Processing ZIP: $ZIP_PATH"
            sudo xattr -rc "$ZIP_PATH" 2>/dev/null || true
            sudo xattr -d com.apple.quarantine "$ZIP_PATH" 2>/dev/null || true
            echo "âœ… ZIP processed: $ZIP_PATH"
          done
          
          # Copy installation script and create README
          cat > out/cyoda-build/make/README-INSTALLATION.md << 'EOF'
          # ðŸš€ Installing Cyoda on macOS
          
          ## ðŸ“¥ Simple Installation (No Terminal Required!)
          
          1. **Download** `Cyoda-*.dmg` file
          2. **Double-click** the DMG file to open it
          3. **Drag** Cyoda.app to Applications folder
          4. **Right-click** on Cyoda.app in Applications â†’ **Open**
          5. **Click "Open"** when macOS asks for confirmation
          
          ## ðŸŽ¯ Alternative Method (Command Line)
          
          If the app shows "damaged" error:
          
          ```bash
          # Remove quarantine (one-time only)
          sudo xattr -d com.apple.quarantine /Applications/Cyoda.app
          
          # Launch normally
          open /Applications/Cyoda.app
          ```
          
          ## â“ Why These Steps?
          
          - **Cyoda is not signed** with Apple Developer certificate (saves $99/year)
          - **macOS protects** you by blocking unsigned apps by default
          - **This is safe** - just requires one-time approval
          - **After approval** - app works normally like any other app
          
          ## ï¿½ Pro Tip
          
          **Use Cmd+Right-Click** on the app â†’ **Open** to bypass the warning instantly!
          
          ## ðŸ†˜ Still Having Issues?
          
          1. Try: **System Preferences** â†’ **Security & Privacy** â†’ **General**
          2. Look for message about "Cyoda" â†’ **Click "Open Anyway"**
          3. Or contact support if needed
          EOF
          
          echo "ðŸŽ‰ All artifacts prepared for distribution!"
        timeout-minutes: 10
        continue-on-error: true

      - name: List macOS build artifacts
        if: matrix.platform == 'darwin'
        run: |
          echo "ðŸ“‚ Listing all files in packages/desktop/out directory:"
          find packages/desktop/out -type f -name "*" | head -20
          
          echo "ðŸ“¦ Checking specific file types:"
          echo "DMG files:"
          find packages/desktop/out -name "*.dmg" -type f || echo "No DMG files found"
          echo "ZIP files:"
          find packages/desktop/out -name "*.zip" -type f || echo "No ZIP files found"
        shell: bash

      - name: Build for Windows
        if: matrix.platform == 'win32'
        run: |
          echo "ðŸ”§ Building for Windows..."
          yarn workspace desktop make --platform=win32 --arch=${{ matrix.arch }}
        timeout-minutes: 10
        shell: bash

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.files }}
          if-no-files-found: warn
          retention-days: 30

      - name: Set release body (Linux only)
        if: matrix.platform == 'linux' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-tag.outputs.new_tag || github.ref_name }}
          name: "Cyoda Platform v${{ needs.create-tag.outputs.version || github.ref_name }}"
          body_path: ${{ github.workspace }}/release_notes.md
          files: ${{ matrix.files }}
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false
          make_latest: true

      - name: Upload to GitHub Releases (macOS/Windows)
        if: matrix.platform != 'linux' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-tag.outputs.new_tag || github.ref_name }}
          files: ${{ matrix.files }}
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false
          append_body: true
          make_latest: true

  # Cleanup source code archives from release
  cleanup-release:
    needs: [ create-tag, build ]
    if: always() && needs.create-tag.result == 'success' && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Remove source code archives
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tagName = '${{ needs.create-tag.outputs.new_tag || github.ref_name }}';
            
            try {
              // Get the release
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tagName
              });
              
              console.log(`ðŸ” Found release: ${release.data.name} (${release.data.tag_name})`);
              
              // Get all assets
              const assets = await github.rest.repos.listReleaseAssets({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.data.id
              });
              
              // Find and delete source code archives
              for (const asset of assets.data) {
                if (asset.name.includes('Source code') || asset.name.endsWith('.tar.gz') || 
                    (asset.name.endsWith('.zip') && asset.name.includes(tagName))) {
                  console.log(`ðŸ—‘ï¸ Deleting source archive: ${asset.name}`);
                  await github.rest.repos.deleteReleaseAsset({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    asset_id: asset.id
                  });
                  console.log(`âœ… Deleted: ${asset.name}`);
                }
              }
              
              console.log('ðŸŽ‰ Source code archives cleanup completed');
            } catch (error) {
              console.log(`âš ï¸ Cleanup error: ${error.message}`);
              // Don't fail the workflow if cleanup fails
            }
